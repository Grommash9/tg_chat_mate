<!DOCTYPE html>
<html>
<head>
  <title>Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/main.css">
  <script src="/socket.io/socket.io.js"></script>
  <script>
    let active_chat = 0
    const socket = io();
    socket.on('new_message', function(message) {
        getChatListFromApi();
        DisplayMessage(message);
    });

    document.addEventListener('DOMContentLoaded', function() {
        getChatListFromApi();
        let message_send_button = document.getElementById('message-send-button');
        message_send_button.addEventListener("click", sendMessageToCustomer);
        document.getElementById('attachment-send-button').addEventListener('click', FileUpload);
    });

    // function FileUpload () {
    //     document.getElementById('file-input').click();

    //     document.getElementById('file-input').addEventListener('change', function(event) {
    //     const file = event.target.files[0];
    //     if (file) {
    //         const formData = new FormData();
    //         formData.append('file', file);
    //         let headers = {"X-Filename": file.name, "Content-Type": file.type}
    //         fetch('/tg-bot/file_upload', {
    //             method: 'POST',
    //             body: formData,
    //             headers: headers,
    //         })
    //         .then(response => response.json())
    //         .then(data => {
    //             if (data.error && data.error === 'file uploaded!') {
    //                 const fileList = document.getElementById('files-attachment-list');
    //                 fileList.innerHTML = ''; 
    //                 const listItem = document.createElement('li');
    //                 listItem.innerText = file.name;
    //                 listItem.id = data["file_id"]
    //                 const removeButton = document.createElement('button');
    //                 removeButton.innerText = 'Remove';
    //                 removeButton.onclick = function() {
    //                     listItem.remove(); 
    //                 };

    //                 listItem.appendChild(removeButton);
    //                 fileList.appendChild(listItem);
    //                 console.log("File uploaded id:", data["file_id"])
    //             } else {
    //                 console.error('Failed to upload file:', data.error);
    //             }
    //         })
    //         .catch(error => {
    //             console.error('There has been a problem with your fetch operation:', error);
    //         });
    //     }
    //     });}
    function FileUpload() {
        console.log('file upload?')
        document.getElementById('file-input').click();

        document.getElementById('file-input').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
            // Read the file as a binary blob
            const reader = new FileReader();
            reader.onload = function(evt) {
                const binary = evt.target.result;
                let headers = {
                "X-Filename": file.name,
                "Content-Type": file.type
                };
                // Send the binary blob in the fetch body
                fetch('/tg-bot/file_upload', {
                method: 'POST',
                body: binary,
                headers: headers,
                })
                .then(response => response.json())
                .then(data => {
                if (data.error && data.error === 'file uploaded!' || data.error === 'file already exists!') {
                    const fileList = document.getElementById('files-attachment-list');
                    fileList.innerHTML = ''; 
                    const listItem = document.createElement('li');
                    listItem.innerText = file.name;
                    listItem.id = data["file_id"]
                    const removeButton = document.createElement('button');
                    removeButton.innerText = 'Remove';
                    removeButton.onclick = function() {
                        listItem.remove(); 
                    };

                    listItem.appendChild(removeButton);
                    fileList.appendChild(listItem);
                    console.log("File uploaded id:", data["file_id"])
                } else {
                    console.error('Failed to upload file:', data.error);
                }
            })
                .catch(error => {
                console.error('There has been a problem with your fetch operation:', error);
                });
            };
            reader.readAsArrayBuffer(file);
            }
        });
        }


    function sendMessageToCustomer() {

        file_attachment_id = null

        const fileList = document.getElementById('files-attachment-list');
        const fileAttachedList = fileList.querySelectorAll('li');

        fileAttachedList.forEach(fileAttached => {
            file_attachment_id = fileAttached.id
        })


        let message_text_input = document.getElementById('message-input');

        let message_text = message_text_input.value;
        console.log(message_text, active_chat)
        const payload = {
        "chat_id": active_chat,
        "text": message_text,
        "file_attachment_id": file_attachment_id,
        };

        var authToken = getCookie("AUTHToken");
        fetch(`/tg-bot/new-message`, {
        method: 'POST', // Set the method to POST
        headers: {
            'Content-Type': 'application/json',
            "AuthorizationToken": authToken
        },
        body: JSON.stringify(payload) // Stringify your payload and set it in the body property
        })
        .then(response => {
        if (!response.status === 200) {
            throw new Error('Network response was not ok');
        }
        fileList.innerHTML = ''; 
        message_text_input.value = ""
        
        return response.json(); // Parse the response as JSON if necessary
        })
        .then(data => {
        console.log('Success:', data);
        })
        .catch((error) => {
        console.error('Error:', error);
        });
    };

        
    
    function loadChatMessages(chat_id) {
        var authToken = getCookie("AUTHToken");
        fetch('/tg-bot/get-messages/' + chat_id, {
            method: 'GET',
            headers: {
            'AuthorizationToken': authToken,
        }
        }
        )
                .then(response => {
                            if (!response.status === 200) {
                                throw new Error('Network response was not ok ' + response.statusText);
                            }
                            
                            return response.json(); // Parse JSON response
                        })
                        .then(data => {
                            // Display the data
                            console.log('Data received:', data);
                            displayChatHistory(data); // Function to handle the display of data
                        })
                        .catch(error => {
                            console.error('There has been a problem with your fetch operation:', error);
                        });
    }

    function displayChatHistory(message_list) {
        const messagesList = document.getElementById('messages-list');
        messagesList.innerHTML = '';
        message_list.messages_list.forEach(message_from_db => {
            DisplayMessage(message_from_db);
        })
        
    }

    function DisplayMessage(message_object) {
        const messagesList = document.getElementById('messages-list');
        const messageElement = document.createElement('li');
        if (String(message_object.from_user) === String(active_chat)) {
            messageElement.className = "message-from-client";
        } else {
            messageElement.className = "message-from-manager";
        }
        if (message_object.attachment && message_object.attachment.mime_type) {
            const attachment_source = '/tg-bot/file?file_uuid=' + message_object.attachment.file_id;
            if (message_object.attachment.mime_type.startsWith('image/')) {
                const photoObject = document.createElement('img');
                photoObject.src = attachment_source;
                photoObject.width = 200;
                photoObject.height = 300;
                messageElement.appendChild(photoObject);}
            else if (message_object.attachment.mime_type.startsWith('video/')) {
                // If it's a video, create a video element
                const videoObject = document.createElement('video');
                videoObject.src = attachment_source;
                videoObject.width = 400; // Set your desired width
                videoObject.height = 300; // Set your desired height
                videoObject.controls = true; // Add controls so the user can play the video
                messageElement.appendChild(videoObject);}
            else if (message_object.attachment.mime_type.startsWith('audio/')) {
                // If it's a video, create a video element
                const audioObject = document.createElement('audio');
                audioObject.src = attachment_source;
                audioObject.controls = true;
                messageElement.appendChild(audioObject);}
                
            else if (message_object.attachment.mime_type.startsWith('application/')) {
                // Extract the file extension for display, if available
                const fileExtension = message_object.attachment.file_name.split('.').pop() || 'file';
                console.log(fileExtension)
                // Create an icon or text to indicate the file type
                const fileIcon = document.createElement('span');
                fileIcon.innerText = `${fileExtension.toUpperCase()} File`; // Display the file extension
                messageElement.appendChild(fileIcon);
                
                const EmptyNewLine = document.createElement('p');
                // Create a download link
                const downloadLink = document.createElement('a');
                downloadLink.href = attachment_source;
                downloadLink.innerText = `${message_object.attachment.file_name}`;
                downloadLink.download = message_object.attachment.file_name; // Suggest a default filename for download
                messageElement.appendChild(EmptyNewLine)
                messageElement.appendChild(downloadLink);}
        }

        const messageText = document.createElement('p');
        console.log(message_object)
        messageText.innerText = message_object.message_text;
        messageElement.appendChild(messageText);
        messagesList.appendChild(messageElement);
        messageElement.scrollIntoView({behavior: "smooth"});
    }


    function getCookie(name) {
    var cookieArr = document.cookie.split(";");
    for(var i = 0; i < cookieArr.length; i++) {
        var cookiePair = cookieArr[i].split("=");
        if(name == cookiePair[0].trim()) {
            return decodeURIComponent(cookiePair[1]);
        }
    }
    return "";
    }

    function getChatListFromApi() {
        var authToken = getCookie("AUTHToken");
        console.log(authToken)

        fetch('/tg-bot/chat-list', {
            method: 'GET',
            headers: {
            'AuthorizationToken': authToken,
        }
        })
                .then(response => {
                    if (!response.status === 200) {
                        throw new Error('Network response was not ok ' + response.statusText);
                    }
                    
                    return response.json(); // Parse JSON response
                })
                .then(data => {
                    // Display the data
                    console.log('Data received:', data);
                    displayDialogList(data); // Function to handle the display of data
                })
                .catch(error => {
                    console.error('There has been a problem with your fetch operation:', error);
                });
    }

    function displayDialogList(chat_list) {
        const contacList = document.getElementById('contacts');
        contacList.innerHTML = '';
        

        chat_list.chat_list.forEach(chatItem => {
        const ContactItem = document.createElement('li');
        ContactItem.id = `contact-item-object_${chatItem.user_id}`;
        ContactItem.className = 'contact-item';

        if (String(active_chat) === String(chatItem.user_id)) {
            ContactItem.classList.add('active-contact');
        }

        const nameParagraph = document.createElement('p');
        nameParagraph.textContent = chatItem.name;
        ContactItem.appendChild(nameParagraph);

        // Create and append the <p> elements for the last message text
        const messageParagraph = document.createElement('p');
        messageParagraph.textContent = chatItem.last_message_text;
        ContactItem.appendChild(messageParagraph);

        // Create and append the <p> elements for the last message time
        const timeParagraph = document.createElement('p');
        timeParagraph.textContent = chatItem.last_message_time;
        ContactItem.appendChild(timeParagraph);
        
        const UnreadMessagesCount = document.createElement('p');
        UnreadMessagesCount.textContent = chatItem.unread_count;
        ContactItem.appendChild(UnreadMessagesCount);
        contacList.appendChild(ContactItem);

        
        });
        let contactListItems = document.querySelectorAll('#contacts li');

        contactListItems.forEach((li) => {

            li.addEventListener('click', function() {
                contactListItems.forEach((item) => {
                item.classList.remove('active-contact');
                });
            console.log('Item clicked:', this.textContent);
            let uniqueNumber = this.id.split('_')[1];
            console.log("Unique chat ID:", uniqueNumber);
            loadChatMessages(uniqueNumber);

            this.classList.add('active-contact');
            active_chat = uniqueNumber
            });
        });
    }
    console.log("active_chat", active_chat)

  </script>
</head>
<body>
    <div class="main-page-container">
        <div class="contants-list">
            <ul id="contacts" class="contacts-list-object">
                <!-- <li id="contact-item-object_1" class="contact-item">
                    <p>Takoj-to chel</p>
                    <p>Privet</p>
                    <p>17.05</p>
                    <p>(7)</p>
                </li> -->
            </ul>
        </div>
        <div class="chat-window">
            
            <div id="top_chat_setting_panel" class="chat-setting">
                <button class="back-button">Back to contacts</button>
            </div>
            <div id="messages_list_box" class="messages-list-box">
                <ul id="messages-list" class="message-list-object">
                    <!-- <li class="message-from-client">
                        <p>Privet tu tut</p>
                        <p>17.02</p>
                    </li> -->
                </ul>
            </div>
            <div id="input_chat_box" class="input-chat-bot-object">

                <input id="message-input" class="message-input-form" autocomplete="off" />
                <button id="message-send-button">Send Message</button>
                <input type="file" id="file-input" hidden />
                <button id="attachment-send-button">Send Attachment</button>

                <ul id="files-attachment-list" class="files-attachment-list-object">
                </ul>

            </div>
            
        </div>
        
    </div>
</body>
</html>
