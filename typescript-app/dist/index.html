<!DOCTYPE html>
<html>
<head>
  <title>Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/main.css">
  <script src="/socket.io/socket.io.js"></script>
  <script>
    // TODO MAKE DOMAIN CHANGABLE IN DOCKER 
    const api_domain = "test10.telegram-crm.work";
    const socket = io();
    socket.on('new_message', function(message) {
        const messagesList = document.getElementById('messages-list');
        const messageElement = document.createElement('li');
        messageElement.className = "message-from-manager";
        messageElement.classList.add("message-from-manager")
        const messageText = document.createElement('p');
        console.log(message)
        messageText.innerText = message.text;
        messageElement.appendChild(messageText);
        messagesList.appendChild(messageElement);

        messageElement.scrollIntoView({behavior: "smooth"});
    });

    document.addEventListener('DOMContentLoaded', getChatListFromApi);
    
    function loadChatMessages(chat_id) {
        fetch('https://' + api_domain + '/tg-bot/get-messages/' + chat_id)
                .then(response => {
                            if (!response.status === 200) {
                                throw new Error('Network response was not ok ' + response.statusText);
                            }
                            
                            return response.json(); // Parse JSON response
                        })
                        .then(data => {
                            // Display the data
                            console.log('Data received:', data);
                            displayChatHistory(data); // Function to handle the display of data
                        })
                        .catch(error => {
                            console.error('There has been a problem with your fetch operation:', error);
                        });
    }

    function displayChatHistory(message_list) {
        const messagesList = document.getElementById('messages-list');
        messagesList.innerHTML = '';
        message_list.messages_list.forEach(message_from_db => {
            const messageElement = document.createElement('li');
            messageElement.className = "message-from-manager";
            messageElement.classList.add("message-from-manager")
            const messageText = document.createElement('p');
            console.log(message_from_db)
            messageText.innerText = message_from_db.message_text;
            messageElement.appendChild(messageText);
            messagesList.appendChild(messageElement);
            messageElement.scrollIntoView({behavior: "smooth"});
        })
        
    }

    function getChatListFromApi() {
        fetch('https://' + api_domain + '/tg-bot/chat-list')
                .then(response => {
                    if (!response.status === 200) {
                        throw new Error('Network response was not ok ' + response.statusText);
                    }
                    
                    return response.json(); // Parse JSON response
                })
                .then(data => {
                    // Display the data
                    console.log('Data received:', data);
                    displayDialogList(data); // Function to handle the display of data
                })
                .catch(error => {
                    console.error('There has been a problem with your fetch operation:', error);
                });
    }

    function displayDialogList(chat_list) {
        chat_list.chat_list.forEach(chatItem => {
        const contacList = document.getElementById('contacts');
        const ContactItem = document.createElement('li');
        ContactItem.id = `contact-item-object_${chatItem.user_id}`;
        ContactItem.className = 'contact-item';

        const nameParagraph = document.createElement('p');
        nameParagraph.textContent = chatItem.name;
        ContactItem.appendChild(nameParagraph);

        // Create and append the <p> elements for the last message text
        const messageParagraph = document.createElement('p');
        messageParagraph.textContent = chatItem.last_message_text;
        ContactItem.appendChild(messageParagraph);

        // Create and append the <p> elements for the last message time
        const timeParagraph = document.createElement('p');
        timeParagraph.textContent = chatItem.last_message_time;
        ContactItem.appendChild(timeParagraph);
        
        const UnreadMessagesCount = document.createElement('p');
        UnreadMessagesCount.textContent = chatItem.unread_count;
        ContactItem.appendChild(UnreadMessagesCount);
        contacList.appendChild(ContactItem);

        
        });
        let contactListItems = document.querySelectorAll('#contacts li');

        contactListItems.forEach((li) => {
            li.addEventListener('click', function() {
            console.log('Item clicked:', this.textContent);
            let uniqueNumber = this.id.split('_')[1];
            console.log("Unique chat ID:", uniqueNumber);
            loadChatMessages(uniqueNumber);
            });
        });
    }

  </script>
</head>
<body>
    <div class="main-page-container">
        <div class="contants-list">
            <ul id="contacts" class="contacts-list-object">
                <!-- <li id="contact-item-object_1" class="contact-item">
                    <p>Takoj-to chel</p>
                    <p>Privet</p>
                    <p>17.05</p>
                    <p>(7)</p>
                </li> -->
            </ul>
        </div>
        <div class="chat-window">
            
            <div id="top_chat_setting_panel" class="chat-setting">
                <button class="back-button">Back to contacts</button>
            </div>
            <div id="messages_list_box" class="messages-list-box">
                <ul id="messages-list" class="message-list-object">
                    <li class="message-from-client">
                        <p>Privet tu tut</p>
                        <p>17.02</p>
                    </li>
                    <li class="message-from-client">
                        <p>Privet tu tut</p>
                        <p>17.02</p>
                    </li>
                    <li class="message-from-manager">
                        <p>Da brat</p>
                        <p>18.02</p>
                    </li>
                    <li class="message-from-manager">
                        <p>Da brat</p>
                        <p>18.02</p>
                    </li>
                    <li class="message-from-client">
                        <p>Privet tu tut</p>
                        <p>17.02</p>
                    </li>
                    <li class="message-from-client">
                        <p>Privet tu tut</p>
                        <p>17.02</p>
                    </li>
                    <li class="message-from-manager">
                        <p>Da brat</p>
                        <p>18.02</p>
                    </li>
                    <li class="message-from-manager">
                        <p>Da brat</p>
                        <p>18.02</p>
                    </li>
                    <li class="message-from-client">
                        <p>Privet tu tut</p>
                        <p>17.02</p>
                    </li>
                    <li class="message-from-client">
                        <p>Privet tu tut</p>
                        <p>17.02</p>
                    </li>
                    <li class="message-from-manager">
                        <p>Da brat</p>
                        <p>18.02</p>
                    </li>
                    <li class="message-from-manager">
                        <p>Da brat</p>
                        <p>18.02</p>
                    </li>
                </ul>
            </div>
            <div id="input_chat_box" class="input-chat-bot-object">
                <form id="form" action="">
                    <input id="input" class="message-input-form" autocomplete="off" /><button>Send</button>
                </form>
            </div>
            
        </div>
        
    </div>
</body>
</html>
