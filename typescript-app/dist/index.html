<!DOCTYPE html>
<html>
<head>
  <title>Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/main.css">
  <script src="/socket.io/socket.io.js"></script>
  <script>
    // TODO MAKE DOMAIN CHANGABLE IN DOCKER 
    const api_domain = 'test12.telegram-crm.work';
    let active_chat = 0
    const socket = io();
    socket.on('new_message', function(message) {
        getChatListFromApi();

        if (String(message.chat_id) === String(active_chat)) {
            
            const messagesList = document.getElementById('messages-list');
            const messageElement = document.createElement('li');
            if (String(message.from_user_id) === String(active_chat)) {
                messageElement.className = "message-from-client";
            } else {
                messageElement.className = "message-from-manager";
            }
            
            const messageText = document.createElement('p');
            console.log(message)
            messageText.innerText = message.text;
            messageElement.appendChild(messageText);
            messagesList.appendChild(messageElement);

            messageElement.scrollIntoView({behavior: "smooth"});
        }
    });

    document.addEventListener('DOMContentLoaded', function() {
        getChatListFromApi();
        let message_send_button = document.getElementById('message-send-button');
        message_send_button.addEventListener("click", sendMessageToCustomer);
    });

    function sendMessageToCustomer() {
        let message_text_input = document.getElementById('message-input');

        let message_text = message_text_input.value;
        console.log(message_text, active_chat)
        const payload = {
        "chat_id": active_chat,
        "text": message_text
        };

        var authToken = getCookie("AUTHToken");
        fetch(`https://${api_domain}/tg-bot/new-message`, {
        method: 'POST', // Set the method to POST
        headers: {
            'Content-Type': 'application/json',
            "AuthorizationToken": authToken
        },
        body: JSON.stringify(payload) // Stringify your payload and set it in the body property
        })
        .then(response => {
        if (!response.status === 200) {
            throw new Error('Network response was not ok');
        }
        message_text_input.value = ""
        return response.json(); // Parse the response as JSON if necessary
        })
        .then(data => {
        console.log('Success:', data);
        })
        .catch((error) => {
        console.error('Error:', error);
        });
    };

        
    
    function loadChatMessages(chat_id) {
        var authToken = getCookie("AUTHToken");
        fetch('https://' + api_domain + '/tg-bot/get-messages/' + chat_id, {
            method: 'GET',
            headers: {
            'AuthorizationToken': authToken,
        }
        }
        )
                .then(response => {
                            if (!response.status === 200) {
                                throw new Error('Network response was not ok ' + response.statusText);
                            }
                            
                            return response.json(); // Parse JSON response
                        })
                        .then(data => {
                            // Display the data
                            console.log('Data received:', data);
                            displayChatHistory(data); // Function to handle the display of data
                        })
                        .catch(error => {
                            console.error('There has been a problem with your fetch operation:', error);
                        });
    }

    function displayChatHistory(message_list) {
        const messagesList = document.getElementById('messages-list');
        messagesList.innerHTML = '';
        message_list.messages_list.forEach(message_from_db => {
            const messageElement = document.createElement('li');

            if (String(message_from_db.from_user) === String(active_chat)) {
                messageElement.className = "message-from-client";
            } else {
                messageElement.className = "message-from-manager";
            }
            if (message_from_db.attachment) {
                fetchImageWithHeaders(message_from_db.attachment, messageElement);
            }

            const messageText = document.createElement('p');
            console.log(message_from_db)
            messageText.innerText = message_from_db.message_text;
            messageElement.appendChild(messageText);
            messagesList.appendChild(messageElement);
            messageElement.scrollIntoView({behavior: "smooth"});
        })
        
    }

    function fetchImageWithHeaders(attachmentId, messageElement) {
    var authToken = getCookie("AUTHToken");
    const image_source = 'https://' + api_domain + '/tg-bot/file?file_uuid=' + attachmentId;
    
    fetch(image_source, {
        method: 'GET',
        headers: {
            'AuthorizationToken': authToken,
        }
    })
    .then(response => response.blob())
    .then(blob => {
        const url = URL.createObjectURL(blob);
        const photoObject = document.createElement('img');
        photoObject.src = url;
        photoObject.width = 200;
        photoObject.height = 300;
        messageElement.appendChild(photoObject);
    })
    .catch(error => console.error('Error fetching the image:', error));
}

    function getCookie(name) {
    var cookieArr = document.cookie.split(";");
    for(var i = 0; i < cookieArr.length; i++) {
        var cookiePair = cookieArr[i].split("=");
        if(name == cookiePair[0].trim()) {
            return decodeURIComponent(cookiePair[1]);
        }
    }
    return "";
    }

    function getChatListFromApi() {
        var authToken = getCookie("AUTHToken");
        console.log(authToken)

        fetch('https://' + api_domain + '/tg-bot/chat-list', {
            method: 'GET',
            headers: {
            'AuthorizationToken': authToken,
        }
        })
                .then(response => {
                    if (!response.status === 200) {
                        throw new Error('Network response was not ok ' + response.statusText);
                    }
                    
                    return response.json(); // Parse JSON response
                })
                .then(data => {
                    // Display the data
                    console.log('Data received:', data);
                    displayDialogList(data); // Function to handle the display of data
                })
                .catch(error => {
                    console.error('There has been a problem with your fetch operation:', error);
                });
    }

    function displayDialogList(chat_list) {
        const contacList = document.getElementById('contacts');
        contacList.innerHTML = '';
        

        chat_list.chat_list.forEach(chatItem => {
        const ContactItem = document.createElement('li');
        ContactItem.id = `contact-item-object_${chatItem.user_id}`;
        ContactItem.className = 'contact-item';

        if (String(active_chat) === String(chatItem.user_id)) {
            ContactItem.classList.add('active-contact');
        }

        const nameParagraph = document.createElement('p');
        nameParagraph.textContent = chatItem.name;
        ContactItem.appendChild(nameParagraph);

        // Create and append the <p> elements for the last message text
        const messageParagraph = document.createElement('p');
        messageParagraph.textContent = chatItem.last_message_text;
        ContactItem.appendChild(messageParagraph);

        // Create and append the <p> elements for the last message time
        const timeParagraph = document.createElement('p');
        timeParagraph.textContent = chatItem.last_message_time;
        ContactItem.appendChild(timeParagraph);
        
        const UnreadMessagesCount = document.createElement('p');
        UnreadMessagesCount.textContent = chatItem.unread_count;
        ContactItem.appendChild(UnreadMessagesCount);
        contacList.appendChild(ContactItem);

        
        });
        let contactListItems = document.querySelectorAll('#contacts li');

        contactListItems.forEach((li) => {

            li.addEventListener('click', function() {
                contactListItems.forEach((item) => {
                item.classList.remove('active-contact');
                });
            console.log('Item clicked:', this.textContent);
            let uniqueNumber = this.id.split('_')[1];
            console.log("Unique chat ID:", uniqueNumber);
            loadChatMessages(uniqueNumber);

            this.classList.add('active-contact');
            active_chat = uniqueNumber
            });
        });
    }
    console.log("active_chat", active_chat)

  </script>
</head>
<body>
    <div class="main-page-container">
        <div class="contants-list">
            <ul id="contacts" class="contacts-list-object">
                <!-- <li id="contact-item-object_1" class="contact-item">
                    <p>Takoj-to chel</p>
                    <p>Privet</p>
                    <p>17.05</p>
                    <p>(7)</p>
                </li> -->
            </ul>
        </div>
        <div class="chat-window">
            
            <div id="top_chat_setting_panel" class="chat-setting">
                <button class="back-button">Back to contacts</button>
            </div>
            <div id="messages_list_box" class="messages-list-box">
                <ul id="messages-list" class="message-list-object">
                    <!-- <li class="message-from-client">
                        <p>Privet tu tut</p>
                        <p>17.02</p>
                    </li> -->
                </ul>
            </div>
            <div id="input_chat_box" class="input-chat-bot-object">
                <!-- <form id="form" action=""> -->
                <input id="message-input" class="message-input-form" autocomplete="off" />
                <button id="message-send-button">Send Message</button>
                <!-- </form> -->
            </div>
            
        </div>
        
    </div>
</body>
</html>
